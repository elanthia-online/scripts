=begin
  EG Guidebook Companion
  Reads and outputs a more friendly formatted display.
  Please have guidebook on you and readable (stored in an open container)

  SYNTAX:
    ;guidebook                      - Shows both merchants/raffles
    ;guidebook w(hisper)            - Shows both merchants/raffles, uses guidebook whisper command instead of GO2
    ;guidebook m(erchant)           - Shows only merchants
    ;guidebook r(affle)             - Shows only raffles
    ;guidebook m(erchant) w(hisper) - Shows only merchants, uses guidebook whisper command instead of GO2
    ;guidebook r(affle) w(hisper)   - Shows only raffles, uses guidebook whisper command instead of GO2

         todo: unsure
       author: elanthia-online
 contributors: Tysong
         name: guidebook
         tags: eg, ebon gate, ebon, guidebook, guide, merchant, raffle
      version: 1.0.8
      website: https://github.com/elanthia-online/scripts/

  changelog:
        1.0.8 (2025-10-17)
            Added support to add w/whisper to launch to replace go2 with whisper functionality, requires
            unlocking of guidebook quest to work.
        1.0.7 (2025-10-17)
            Added support for RealID# matching from original source XML links
        1.0.6 (2025-10-17)
            Additional regex updates
            Include merchant name in raffle output
        1.0.5 (2022-10-18)
            Regex updates for more things
        1.0.4 (2022-10-18)
            Added error handling for missing terminal-table gem
            Added display of additional go2 room# matches incase multiple
        1.0.3 (2022-10-18)
            Add handling for guidebook not on epilogue or not found/unreadable.
        1.0.2 (2022-10-18)
            Add line breaks for long raffle descriptions.
            Added Totals to merchant and raffle listings.
            Added clickable ;go2 links for PnC clients.
        1.0.1 (2022-10-17)
            Regex updates
        1.0.0 (2022-10-17)
            Initial release

=end

begin
  require 'terminal-table'
rescue LoadError
  respond "You need to have the 'terminal-table' gem installed"
  respond "Please install it with the following command: gem install terminal-table"
  respond "Via your computer's local terminal/shell"
  exit
end

def find_room_by_title_and_uid(uid, title)
  {
    "Flightless Dragonfly" => 8084542,
  }.each { |key, value|
    return value if key.to_s == title
  }

  if Room[Map.ids_from_uid(uid).first].title.any? { |t| t =~ /#{title}/i }
    # echo "1: #{uid}"
    return uid
  end

  Room[Map.ids_from_uid(uid).first].wayto.keys.each { |room|
    if Room[room].title.any? { |t| t =~ /#{title}/i }
      # echo "2:#{Room[room].uid.first}"
      return Room[room].uid.first
    end
  }

  found_room = Map.list.find { |r|
    r.title.find { |t| t =~ /#{title}/i }
  }
  if found_room
    # echo "3: #{found_room.uid.first}"
    return found_room.uid.first
  end

  # echo "4: #{uid}"
  return uid
end

guidebook_merchants = {}
guidebook_raffles   = {}

regex_merchant = /#\d+\s+(?<name>[\w\s,'.]+?)   \s+(?<room>[\w\s,'.-]+?)  \s+<d cmd='whisper my guidebook service \d+ \d+ (?<real_id>\d+)'>\[Shop Entrance\] <\/d>(?<details>.*)/
regex_raffle   = /#\d+\s+(?<name>\w+)\s+(?<room>[\w\s,'.-]+?)\s+(?<datetime>\d+\/\d+\/\d+ \d+:\d+:\d+) (?<zone>\w+)\s+(?<cost>[\d,]+) \w+ \s+<d cmd='whisper my guidebook raffle \d+ \d+ (?<real_id>\d+)'>/

guidebook_output = Lich::Util.quiet_command_xml("read guidebook", /<output class="mono"\/>|You can't do that\./, /<prompt/, true, 5, true)

if guidebook_output.to_s =~ /You can't do that./ || guidebook_output.to_s !~ /Epilogue/
  respond "You need to have an EG guidebook on your character and in a location/container that makes it readable."
  respond "Also please have the guidebook flipped to Chapter 14, the epilogue."
  exit
end

guidebook_output.each_with_index { |line, index|
  if line =~ regex_merchant
    guidebook_merchants[index] = (line.match(regex_merchant).named_captures)
  elsif line =~ regex_raffle
    raffle = (line.match(regex_raffle).named_captures)
    raffle["description"] = guidebook_output[index + 1]
    raffle["datetime"] = DateTime.strptime(raffle["datetime"], "%m/%d/%Y %H:%M:%S")
    guidebook_raffles[index] = raffle
  end
}

if (Script.current.vars[1]&.downcase =~ /^m/ || Script.current.vars[1]&.downcase !~ /^r/)
  if guidebook_merchants.count == 0
    respond "No merchants working currently!"
  else
    headers = %i[Merchant Room Go2]
    table_rows = []
    guidebook_merchants.each { |_index, merchant|
      table_rows.push([merchant["name"], merchant["room"], "u#{find_room_by_title_and_uid(merchant["real_id"].to_i, merchant["room"])}"])
      table_rows.push([{ :value => merchant["details"].scan(/.{1,90}/).join("\n"), :colspan => 3 }])
      table_rows.push(:separator)
    }
    table_rows.push([{ :value => "Total of #{guidebook_merchants.count} Merchant(s)", :colspan => 3 }])
    table = Terminal::Table.new(
      headings: headers,
      rows: table_rows
    )
    table = table.to_s
    if table =~ /\n\|([\w\s\|]+)\|\n/
      header = $1
      headerbold = Lich::Messaging.monsterbold(header)
      table = table.gsub(header, headerbold)
    end
    loop {
      if table =~ /\|\s+(u?[\d]+)\s+\|/
        go2_cmd = $1
        if Script.current.vars[1]&.downcase =~ /^w/ || Script.current.vars[2]&.downcase =~ /^w/
          go2_cmdbold = "<d cmd='whisper my guidebook service 1 999 #{go2_cmd.gsub('u', '')}'>" + Lich::Messaging.monsterbold(go2_cmd) + "</d>"
        else
          go2_cmdbold = "<d cmd=';go2 #{go2_cmd}'>" + Lich::Messaging.monsterbold(go2_cmd) + "</d>"
        end
        table = table.gsub(go2_cmd, go2_cmdbold)
      else
        break
      end
    }
    _respond "<output class=\"mono\"/>\n" + table + "\n<output class=\"\"/>"
  end
end

if (Script.current.vars[1]&.downcase !~ /^m/ || Script.current.vars[1]&.downcase =~ /^r/)
  if guidebook_raffles.count == 0
    respond "No raffles currently!"
  else
    guidebook_raffles = guidebook_raffles.sort_by { |_a, b| b["datetime"] }
    headers = %i[Merchant Room Go2 DateTime Cost]
    table_rows = []
    guidebook_raffles.each { |_index, raffle|
      table_rows.push([raffle["name"], raffle["room"], "u#{find_room_by_title_and_uid(raffle["real_id"].to_i, raffle["room"])}", raffle["datetime"].strftime("%m/%d/%Y %I:%M %p"), raffle["cost"]])
      table_rows.push([{ :value => raffle["description"].scan(/.{1,90}/).join("\n"), :colspan => 5 }])
      table_rows.push(:separator)
    }
    table_rows.push([{ :value => "Total of #{guidebook_raffles.count} Raffle(s)", :colspan => 5 }])
    table = Terminal::Table.new(
      headings: headers,
      rows: table_rows
    )
    table = table.to_s
    if table =~ /\n\|([\w\s\|]+)\|\n/
      header = $1
      headerbold = Lich::Messaging.monsterbold(header)
      table = table.gsub(header, headerbold)
    end
    loop {
      if table =~ /\|\s+(u?[\d]+)\s+\|/
        go2_cmd = $1
        if Script.current.vars[1]&.downcase =~ /^w/ || Script.current.vars[2]&.downcase =~ /^w/
          go2_cmdbold = "<d cmd='whisper my guidebook raffle 1 999 #{go2_cmd.gsub('u', '')}'>" + Lich::Messaging.monsterbold(go2_cmd) + "</d>"
        else
          go2_cmdbold = "<d cmd=';go2 #{go2_cmd}'>" + Lich::Messaging.monsterbold(go2_cmd) + "</d>"
        end
        table = table.gsub(go2_cmd, go2_cmdbold)
      else
        break
      end
    }
    _respond "<output class=\"mono\"/>\n" + table + "\n<output class=\"\"/>"
  end
end
