=begin
  tourniquet.lic - Deal with Bleeding

            author: elanthia-online
    contributors: Dissonance
            game: Gemstone
            tags: health, bleeding
        version: 1.0.0

  Changelog
    v1.0.0 - 2025-04-30
      - Created
=end


module Tourniquet

  def self.stop_healing
    # return true to stop using healing options
    # heal until 95% or if loss health is a max of 30
    # (Char.health > (Char.max_health-29)) || percent_health > 95
    Char.percent_health >= 95
  end

  def self.check_society_ability
    case Society.member.downcase
    when /voln/
      Spell["Symbol of Restoration"].known?
    when /sunfist/
      Spell["Sigil of Mending"].known?
    when /council/
      Spell["Sign of Staunching"].known? || Spell["Sign of Clotting"].known?
    else
      false
    end
  end

  def self.use_staunching_or_clotting
    unless Spell["Sign of Staunching"].known?
      return unless Spell["Sign of Staunching"].affordable?
      return if Effects::Buffs.active?("Sigil of Determination")
      
      Spell["Sign of Staunching"].cast
    else unless Spell["Sign of Clotting"].known?
      return unless Spell["Sign of Clotting"].affordable?
      return if Effects::Buffs.active?("Sign of Clotting")
      
      Spell["Sign of Clotting"].cast
    end
  end

  def self.use_restoration
    return unless Spell["Symbol of Restoration"].known?
    return unless Spell["Symbol of Restoration"].affordable?

    if Char.percent_health < 65
      # 900 is approximate favor cost for a level 100, so it doesn't loop endlessly if you run out of favor
      # future TODO: would be to determine actual cost at level (as accurate as data allows) and use that
      Spell["Symbol of Restoration"].cast until (stop_healing || Resources.voln_favor < 900)
    end
  end

  def self.use_mending_and_health
    return unless Spell["Sigil of Mending"].known?
    return unless Spell["Sigil of Mending"].affordable?
    return if Effects::Buffs.active?("Sigil of Mending")
  
    Spell["Sigil of Mending"].cast

    if Char.percent_health < 65
      Spell["Sign of Staunching"].cast until stop_healing
    end
  end
end

unless check_society_ability
  echo "You do not have access to an applicable society ability to deal with bleeding or bloodloss."
  exit
end

loop
  case Society.member.downcase
  when /voln/ # member of voln?
    echo "Now Monitoring For Bleeding Condition"
    wait_until { checkbleeding || checkpoison || checkdisease }  # wait to be bleeding or other health loss
    echo "You're bleeding, attempting to resolve this issue..."
    use_restoration
  when /sunfist/ # member of sunfist?
    echo "Now Monitoring For Bleeding Condition"
    wait_until { checkbleeding || checkpoison || checkdisease }  # wait to be bleeding or other health loss
    echo "You're bleeding, attempting to resolve this issue..."
    use_mending_and_health
  when /council/ # member of council?
    echo "Now Monitoring For Bleeding Condition"
    wait_until { checkbleeding }  # wait to be bleeding, can't restore health, just stops bleeding
    echo "You're bleeding, attempting to resolve this issue..."
    use_staunching_or_clotting
  else
    echo "This shouldn't happen.  Please provide the following info to Elanthia Online:  Script Failed: #{Society.member.downcase}"
  end
end
