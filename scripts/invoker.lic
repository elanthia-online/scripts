=begin
  Runs continuously and notifies you when the invoker has returned.
  If you are already in the park it will use them automatically.
  Note: Once it prompts you if you would like to use them,
  the script will not do so automatically if you move in to the room.
  author: Nesmeor
  name: invoker
  tags: utility, spellup
  version: 1.3.0

  Changelog:
    1.3.0 (4/27/2021):
      - Updated to Semantic Versioning
      - Created whispertext to handle messaging
      - Added error messaging for spells being asked multiple times
    1.2 (4/26/2021):
      Added auto-use if in Park room. Removed room customization from command line as the invoker only ever shows up in one place. If you need to change it you can still change the invoker_location variable at the top of the script, but I prefer simplicity where possible :)
    1.1 (4/24/2021):
      Added colorized text for stormfront UI

=end

current_hour = nil
invoker_location = "288"

go2 = proc { | room |
  next if Room.current.id.to_s == room.to_s
  wait_while { running?("go2") }
  start_script("go2", [room.to_s, "_disable_confirm_"])
  wait_while { running?("go2") }
}

check_time = proc {
  # Is it between 00 & 15 minutes?
  time = Time.now.strftime('%M')
  time.to_s =~ /0[1-9]|1[0-5]/
}

ask_for_spells = proc {  
  success = false
  count = 0
  while !success and count < 5
    count += 1
    success = dothistimeout "ask invoker about spells", 5, /releases upon you|Please wait a few minutes before asking again/
    if success =~ /Please wait a few minutes before asking again/
      whispertext "You have already asked for spells, please try again later!"
    end
  end
  next success
}

def whispertext(text)
  if $frontend == 'stormfront'
    puts "\<preset id=\"whisper\"\>#{text}\<\/preset\>"
  else
    echo "#{text}"
  end
end

help = proc {
    whispertext "Runs continuously and notifies you when the invoker has returned."
    whispertext "If you are already in the park it will use them automatically."
    whispertext "Note: Once it prompts you if you would like to use them,"
    whispertext "the script will not do so automatically if you move in to the room."
    exit
}

# Command line handling
if script.vars[1] == "help"
  help.call
  exit
end

# Do this forever
while true
  # Check the current time to see if the invoker is present
  invoker_present = check_time.call
  if invoker_present
    # Capture the current hour to avoid trying multiple times
    new_hour = Time.now.hour
    # Make sure we haven't seen the invoker already
    if current_hour != new_hour
      if Room.current.id.to_s == invoker_location
        ask_for_spells.call
        current_hour = new_hour 
      else
        whispertext "The invoker is now available. YES to visit them, SHAKE to skip this time."
        while line = get
          # If the player doesn't respond in time, stop waiting
          if !check_time
            break
          end
          # If player input YES
          if line =~ /positive attitude/
            # Capture current location
            current_room = Room.current.id
            # Go to the park
            go2.call(invoker_location)
            # Pausing, because sometimes things move to fast for the next check to succeed
            pause 1
            # Ask for spells, track success
            success = ask_for_spells.call
            # Return to previous location
            go2.call(current_room)
            if success
              # Update current time to avoid repeats
              current_hour = new_hour
            else
              # Notify player of failure if unsuccessful
              whispertext "Unable to find the invoker."
            end
            break
          # If player input SHAKE
          elsif line =~ /Shake what\?/
            echo "Skipping invoker this hour."
            # Update time to skip
            current_hour = new_hour
            break
          end
        # Throttle while waiting for user input
        pause 0.5
        end
      end
    end
  end
  # Trottle while waiting for time to pass
  pause '1m'
end
