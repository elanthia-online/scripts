=begin
    Basic Disarmed/Recovery Script
    Script to automatically RECOVER ITEM upon disarmed/item stolen.

    SYNTAX - ;disarmed

    Will automatically pause go2/wander/bigshot/stand upon being disarmed and resume them after finding an item.
	Will echo to story window that your disarmed, LICH room#, and LICH room title. Will also echo to famwindow room# and time.

    https://github.com/elanthia-online/scripts

       todo: unsure
     author: Tysong (horibu on PC)
       name: disarmed
       tags: disarm, disarmed, recover, recovery
    version: 1.2

    changelog:
        1.2 (2019-08-12)
            Fixed slight issue with Spirit Servant recovery
        1.1 (2019-08-12)
            Added initial Spirit Servant recovery option
        1.0 (2019-08-02)
            Initial Release

    credit & thanks:
        Whoever wrote undisarm (no clue on original author)
=end

if $frontend =~ /stormfront|profanity/
	fam_window_begin = "<pushStream id=\"familiar\" ifClosedStyle=\"watching\"/>"
	fam_window_end   = "<popStream/>\r\n"
else
	fam_window_begin = "\034GSe\r\n"
	fam_window_end   = "\034GSf\r\n"
end

sleep 2 if Script.running?("tethereal")

disarmed_left_hand = nil
disarmed_right_hand = nil
servant_recover = false

echo "## DISARMED ACTIVE ##"
echo "## Left Hand: #{GameObj.left_hand.name}"
disarmed_left_hand = GameObj.left_hand.name
echo "## Right Hand: #{GameObj.right_hand.name}"
disarmed_right_hand = GameObj.right_hand.name
echo "## DISARMED READY ##"

loop {
	matchwait /^\[Use the RECOVER ITEM command while in the appropriate room to regain your item\.\]$/
	Script.pause("go2") if Script.running?("go2")
	Script.pause("wander") if Script.running?("wander")
	Script.pause("bigshot") if Script.running?("bigshot")
	Script.pause("stand") if Script.running?("stand")
	
	disarmed_room = Room.current.id
	echo "########## DISARMED!!! ##########"
	echo "## Room#: #{Room.current.id}"
	echo "## Room Name: #{Room.current.title}"
	echo "## Left Hand: #{disarmed_left_hand}/#{GameObj.left_hand.name}"
	echo "## Right Hand: #{disarmed_right_hand}/#{GameObj.right_hand.name}"
	echo "## Other NPCs: #{GameObj.npcs.collect{|npc| npc.name}.join(", ")}"
	echo "## Other PCs: #{GameObj.pcs.collect{|pc| pc.name}.join(", ")}"
	echo "########## DISARMED!!! ##########"
	_respond("#{fam_window_begin}Disarmed - Room#(#{Room.current.id}) - LH(#{disarmed_left_hand}) - RH(#{disarmed_right_hand}) - #{Time.now.strftime('%H:%M:%S').sub(/^0/, '')}\r\n#{fam_window_end}")
	
	exit if checkdead
	waitrt?
	line = nil
	if Spell[218].active?
		line = dothistimeout "tell servant recover", 5, /flickers for a moment and manifests|has no personal recollection/
		if line =~ /flickers for a moment and manifests/
			servant_recover = true 
		else
			servant_recover = false
		end
	end
	if !servant_recover
		fput "stance defensive"
		until(kneeling?)
			waitrt?
			fput "kneel"
			exit if checkdead
		end

		line = nil
		until line =~ /You spy (?:an|a) (?:.*) and recover it\!/
			waitrt?
			if disarmed_room != Room.current.id
				echo "You're not in the appropriate room."
				echo "You're in #{Room.current.id} and you need to be in #{disarmed_room}"
				echo "Moving back in 5 seconds!"
				echo ";kill me if you do not wish to move!"
				sleep 5
				Script.kill("go2") if Script.running?("go2")
				sleep 1 until !Script.running?("go2")
				Script.run("go2", "#{disarmed_room}")
			end
			line = dothistimeout "recover item", 5, /You find nothing recoverable\.|You spy (?:an|a) (?:.*) and recover it\!|...wait (?:.*) seconds\./
		end
	end
	servant_recover = false if servant_recover
	Script.unpause("go2") if Script.paused?("go2")
	Script.unpause("wander") if Script.paused?("wander")
	Script.unpause("bigshot") if Script.paused?("bigshot")
	Script.unpause("stand") if Script.paused?("stand")
	echo "## RECOVERED ##"
	exit if checkdead
}
